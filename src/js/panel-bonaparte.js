var objct = require("objct");
var util = require("./utility");

///////////////////////////////////////////////////////////////////////////////

module.exports = objct(
  require("./tag"), 
  require("./toggle"),
  panel
);

///////////////////////////////////////////////////////////////////////////////

function panel(){

  this.global.addListener("click", clickHandler);
  this.global.addListener("closePanels", closePanels);
  this.addListener("attributeChangedCallback", attributeChangedCallback);
  this.open = open;
  this.close = close;

///////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////
  var tag = this;
  var locked = false;

///////////////////////////////////////////////////////////////////////////////

  function clickHandler(e){
    if(e.target === tag || util.nodeContains(tag, e.target)) 
      lock();
    tag.global.trigger("closePanels");
  }

///////////////////////////////////////////////////////////////////////////////

  function attributeChangedCallback(data){
    if(data.name === "open" && data.newValue == "true") {
      lock();
      tag.global.trigger("closePanels");
    };    
  }

///////////////////////////////////////////////////////////////////////////////

  function closePanels(){
    if(locked) return;
    tag.close();
  }

///////////////////////////////////////////////////////////////////////////////

  function close() {
    tag.setAttribute("open", "false");
  }

///////////////////////////////////////////////////////////////////////////////

  function open(e) {    
    lock();
    tag.setAttribute("open", "true");
  }
///////////////////////////////////////////////////////////////////////////////

  function lock(){
    locked=true;
    setTimeout(function(){ locked=false; },0);
  }
}

///////////////////////////////////////////////////////////////////////////////